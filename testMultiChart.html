<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.css">
    <!-- Include d3.js first -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nvd3/1.8.6/nv.d3.js"></script>

    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        html, body, #chart, svg {
            margin: auto;
            padding: 0px;
            height: 95%;
            width: 95%;
        }
		form  { display: table;      }
		p     { display: table-row;  }
		label { display: table-cell; }
		input { display: table-cell; }
    </style>
</head>
<body class='with-3d-shadow with-transitions'>

<div id="chart" >
    <svg> </svg>
</div>
<p>
	<input type="button" onclick="init_chart()" value="Get Last 24-Hours">
</p>
<br>
<form id="dates" style="font-weight: bold;">
	<p>
		<label for="start_date">Start Date:</label>
		<input type="datetime-local" name="start_date" min="2020-01-01">
	</p>
	<p>
		<label for="end_date">End Date:</label>
		<input type="datetime-local" name="end_date" min="2020-01-01">
	</p>
	<input type="button" onclick="changeDate()" value="Apply">
</form>
<p id="date-msg"></p>
<script>

	
	//initialize chart with last 24-hours of data
	function init_chart(){
		var api_url = getLast24hrs();
		getData(api_url);
	}
	
	//gets the last 24-hour api url
	function getLast24hrs(){
		var endDate = new Date();
		var startDate = new Date(endDate);
		startDate.setDate(startDate.getDate() - 1);
		var sensorID = "001e06323a06";
		var api_url = "http://mintsdata.utdallas.edu:3000/data/" + sensorID + "/" + startDate.toISOString() + "/" + endDate.toISOString();
		return api_url;
	}
	
	//changes the date for the data
	function changeDate(){
		var dateInput = document.getElementById("dates");
		if(!dateInput.elements[0].value || !dateInput.elements[1].value){
			document.getElementById("date-msg").innerHTML = "*Please enter a date.";
			document.getElementById("date-msg").style.color = "red"
			return;
		}
		else{
			document.getElementById("date-msg").innerHTML = "";
		}
		
		var startDate = new Date(dateInput.elements[0].value);
		var endDate = new Date(dateInput.elements[1].value);
		var sensorID = "001e06323a06";
		var api_url = "http://mintsdata.utdallas.edu:3000/data/" + sensorID + "/" + startDate.toISOString() + "/" + endDate.toISOString();
		
		getData(api_url);
	}

	//get data from api and creates chart
	async function getData(api_url){
		const getData = await fetch(api_url)
			.then((resp) => resp.json())	//format response as JSON
			.then((respJSON) => {
				const data = respJSON;
				const dataSet = createData(data);
				//calls chart function here to make sure the data has arrived
				createChart(dataSet);
			})
			.catch(function(error) {
				console.log(error);
			});
	}
	
	//creates data for chart
	function createData(data){
		var val = [];
		for(var i = 0; i < data.length; i++){
			val.push({x:Date.parse(data[i].timestamp), y:data[i].pm2_5});
		}
		return val;
	}

	//creates the chart
    function createChart(val){
		var testdata = [];
		if(val.length){
			//formats the data for the chart
			testdata = [
				//data
				{
					key: "PM 2.5",
					values:[{}]
				},
				//color ranges of µg/m³
				{//0-25µg/m³ yellow
					key: "0-25µg/m³",
					values: [
						{x:val[0].x, y:25},
						{x:val[val.length-1].x, y:25}
					],
					color: "rgba(255,255,0, 0.65)"
				},
				{//25-50µg/m³ orange
					key: "25-50µg/m³",
					values: [
						{x:val[0].x, y:25},
						{x:val[val.length-1].x, y:25}
					],
					color: "rgba(255,128,0, 0.65)"
				},
				{//50-100µg/m³ red
					key: "50-100µg/m³",
					values: [
						{x:val[0].x, y:50},
						{x:val[val.length-1].x, y:50}
					],
					color: "rgba(220,0,0, 0.65)"
				},
				{//100-150µg/m³ purple
					key: "100-150µg/m³",
					values: [
						{x:val[0].x, y:50},
						{x:val[val.length-1].x, y:50}
					],
					color: "rgba(76,0,153, 0.65)"
				},
				{//150+µg/m³ maroon
					key: "150+µg/m³",
					values: [
						{x:val[0].x, y:50},
						{x:val[val.length-1].x, y:50}
					],
					color: "rgba(140,22,22, 0.65)"
				}
			];
			
			//sets the chart types among other things
			testdata[0].type = "line";
			testdata[0].yAxis = 1;
			testdata[0].values = val;	//sets the data from sensor
			testdata[1].type = "area";
			testdata[1].yAxis = 1;
			testdata[2].type = "area";
			testdata[2].yAxis = 1;
			testdata[3].type = "area";
			testdata[3].yAxis = 1;
			testdata[4].type = "area";
			testdata[4].yAxis = 1;
			testdata[5].type = "area";
			testdata[5].yAxis = 1;
		}
		
		nv.addGraph(function() {
			var chart = nv.models.multiChart()
				.margin({top: 30, right: 60, bottom: 50, left: 90})
				.color(d3.scale.category10().range())
				.yDomain1([0, 200]);
			chart.legend.updateState(false);
			chart.xAxis
				.tickFormat(function(d){return d3.time.format('%b %d %I:%M:%S%p')(new Date(d))})
				.staggerLabels(true);
			chart.yAxis1
				.tickFormat(function(d){return d3.format(',.2f')(d) + 'µg/m³'});
			d3.select('#chart svg')
				.datum(testdata)
				.transition()
				.duration(500)
				.call(chart);
			return chart;
		});
	}
	
	//calls function to create the chart
	init_chart();

</script>
</body>
</html>
